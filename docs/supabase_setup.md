# Configuración de Supabase para Cotizador Gigantografía

## 1. Configuración de Tablas

### 1.1. Enum `rol_usuario`
```sql
-- Crear el tipo enum para roles de usuario
CREATE TYPE rol_usuario AS ENUM ('admin', 'empleado');
```

### 1.2. Tabla `empresas`
```sql
-- Crear tabla empresas
CREATE TABLE public.empresas (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  nombre text NOT NULL,
  created_at timestamptz DEFAULT timezone('utc'::text, now()),
  CONSTRAINT empresas_pkey PRIMARY KEY (id)
);
```

### 1.3. Tabla `usuarios`
```sql
-- Crear tabla usuarios
CREATE TABLE public.usuarios (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  auth_user_id uuid NOT NULL UNIQUE,
  empresa_id uuid NOT NULL,
  email text NOT NULL UNIQUE,
  nombre text NOT NULL,
  rol rol_usuario NOT NULL DEFAULT 'empleado',
  archivado boolean NOT NULL DEFAULT false,
  created_at timestamptz DEFAULT timezone('utc'::text, now()),
  CONSTRAINT usuarios_pkey PRIMARY KEY (id),
  CONSTRAINT usuarios_auth_user_id_fkey FOREIGN KEY (auth_user_id) REFERENCES auth.users(id) ON DELETE CASCADE,
  CONSTRAINT usuarios_empresa_id_fkey FOREIGN KEY (empresa_id) REFERENCES public.empresas(id) ON DELETE CASCADE
);
```

### 1.4. Tabla `clientes`
```sql
-- Crear tabla clientes
CREATE TABLE public.clientes (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  nombre text NOT NULL,
  email text,
  celular text,
  notas text,
  empresa_id uuid NOT NULL,
  auth_user_id uuid NOT NULL,
  archivado boolean NOT NULL DEFAULT false,
  created_at timestamptz DEFAULT timezone('utc'::text, now()),
  CONSTRAINT clientes_pkey PRIMARY KEY (id),
  CONSTRAINT clientes_empresa_id_fkey FOREIGN KEY (empresa_id) REFERENCES public.empresas(id) ON DELETE CASCADE,
  CONSTRAINT clientes_auth_user_id_fkey FOREIGN KEY (auth_user_id) REFERENCES auth.users(id) ON DELETE CASCADE
);
```

### 1.5. Tabla `trabajos`
```sql
-- Crear tabla trabajos
CREATE TABLE public.trabajos (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  nombre text NOT NULL,
  precio_m2 numeric NOT NULL,
  empresa_id uuid NOT NULL,
  archivado boolean NOT NULL DEFAULT false,
  created_at timestamptz DEFAULT timezone('utc'::text, now()),
  CONSTRAINT trabajos_pkey PRIMARY KEY (id),
  CONSTRAINT trabajos_empresa_id_fkey FOREIGN KEY (empresa_id) REFERENCES public.empresas(id) ON DELETE CASCADE
);
```

### 1.6. Tabla `ordenes_trabajo`
```sql
-- Crear tabla ordenes_trabajo
CREATE TABLE public.ordenes_trabajo (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  cliente_id uuid NOT NULL,
  empresa_id uuid NOT NULL,
  auth_user_id uuid NOT NULL,
  adelanto numeric NOT NULL DEFAULT 0,
  total_personalizado numeric,
  notas text,
  estado text NOT NULL DEFAULT 'pendiente',
  fecha_entrega date NOT NULL,
  hora_entrega time NOT NULL,
  created_at timestamptz DEFAULT timezone('utc'::text, now()),
  CONSTRAINT ordenes_trabajo_pkey PRIMARY KEY (id),
  CONSTRAINT ordenes_trabajo_cliente_id_fkey FOREIGN KEY (cliente_id) REFERENCES public.clientes(id) ON DELETE CASCADE,
  CONSTRAINT ordenes_trabajo_empresa_id_fkey FOREIGN KEY (empresa_id) REFERENCES public.empresas(id) ON DELETE CASCADE,
  CONSTRAINT ordenes_trabajo_auth_user_id_fkey FOREIGN KEY (auth_user_id) REFERENCES auth.users(id) ON DELETE CASCADE
);
```

### 1.7. Tabla `orden_trabajo_items`
```sql
-- Crear tabla orden_trabajo_items
CREATE TABLE public.orden_trabajo_items (
  id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  orden_id uuid NOT NULL,
  trabajo_nombre text NOT NULL,
  trabajo_precio_m2 numeric NOT NULL,
  ancho numeric NOT NULL,
  alto numeric NOT NULL,
  cantidad integer NOT NULL,
  adicional numeric NOT NULL DEFAULT 0,
  CONSTRAINT orden_trabajo_items_pkey PRIMARY KEY (id),
  CONSTRAINT orden_trabajo_items_orden_id_fkey FOREIGN KEY (orden_id) REFERENCES public.ordenes_trabajo(id) ON DELETE CASCADE
);
```

## 2. Configuración de Row Level Security (RLS)

### 2.1. Activar RLS en las tablas requeridas
```sql
-- Activar RLS en las tablas que requieren aislamiento por empresa
ALTER TABLE public.clientes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.trabajos ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.ordenes_trabajo ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.orden_trabajo_items ENABLE ROW LEVEL SECURITY;
```

### 2.2. Políticas para la tabla `clientes`

```sql
-- Política de SELECT para clientes (acceso general)
CREATE POLICY "clientes_select_policy" ON public.clientes
FOR SELECT
USING (
  (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = empresa_id
);

-- Política de INSERT para clientes
CREATE POLICY "clientes_insert_policy" ON public.clientes
FOR INSERT
WITH CHECK (
  (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = empresa_id
);

-- Política de UPDATE para clientes
CREATE POLICY "clientes_update_policy" ON public.clientes
FOR UPDATE
USING (
  (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = empresa_id
)
WITH CHECK (
  (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = empresa_id
);

-- Política de DELETE para clientes
CREATE POLICY "clientes_delete_policy" ON public.clientes
FOR DELETE
USING (
  (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = empresa_id
);
```

### 2.3. Políticas para la tabla `trabajos`

```sql
-- Política de SELECT para trabajos (acceso general)
CREATE POLICY "trabajos_select_policy" ON public.trabajos
FOR SELECT
USING (
  (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = empresa_id
);

-- Política de INSERT para trabajos (solo admins)
CREATE POLICY "trabajos_insert_policy" ON public.trabajos
FOR INSERT
WITH CHECK (
  (SELECT rol FROM public.usuarios WHERE auth_user_id = auth.uid()) = 'admin'::rol_usuario
  AND
  (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = empresa_id
);

-- Política de UPDATE para trabajos (solo admins)
CREATE POLICY "trabajos_update_policy" ON public.trabajos
FOR UPDATE
USING (
  (SELECT rol FROM public.usuarios WHERE auth_user_id = auth.uid()) = 'admin'::rol_usuario
  AND
  (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = empresa_id
)
WITH CHECK (
  (SELECT rol FROM public.usuarios WHERE auth_user_id = auth.uid()) = 'admin'::rol_usuario
  AND
  (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = empresa_id
);

-- Política de DELETE para trabajos (solo admins)
CREATE POLICY "trabajos_delete_policy" ON public.trabajos
FOR DELETE
USING (
  (SELECT rol FROM public.usuarios WHERE auth_user_id = auth.uid()) = 'admin'::rol_usuario
  AND
  (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = empresa_id
);
```

### 2.4. Políticas para la tabla `ordenes_trabajo`

```sql
-- Política de SELECT para ordenes_trabajo (acceso general)
CREATE POLICY "ordenes_trabajo_select_policy" ON public.ordenes_trabajo
FOR SELECT
USING (
  (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = empresa_id
);

-- Política de INSERT para ordenes_trabajo
CREATE POLICY "ordenes_trabajo_insert_policy" ON public.ordenes_trabajo
FOR INSERT
WITH CHECK (
  (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = empresa_id
);

-- Política de UPDATE para ordenes_trabajo
CREATE POLICY "ordenes_trabajo_update_policy" ON public.ordenes_trabajo
FOR UPDATE
USING (
  (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = empresa_id
)
WITH CHECK (
  (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = empresa_id
);

-- Política de DELETE para ordenes_trabajo
CREATE POLICY "ordenes_trabajo_delete_policy" ON public.ordenes_trabajo
FOR DELETE
USING (
  (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = empresa_id
);
```

### 2.5. Políticas para la tabla `orden_trabajo_items`

```sql
-- Política de SELECT para orden_trabajo_items
CREATE POLICY "orden_trabajo_items_select_policy" ON public.orden_trabajo_items
FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM public.ordenes_trabajo ot
    WHERE ot.id = orden_id
    AND (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = ot.empresa_id
  )
);

-- Política de INSERT para orden_trabajo_items
CREATE POLICY "orden_trabajo_items_insert_policy" ON public.orden_trabajo_items
FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1 FROM public.ordenes_trabajo ot
    WHERE ot.id = orden_id
    AND (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = ot.empresa_id
  )
);

-- Política de UPDATE para orden_trabajo_items
CREATE POLICY "orden_trabajo_items_update_policy" ON public.orden_trabajo_items
FOR UPDATE
USING (
  EXISTS (
    SELECT 1 FROM public.ordenes_trabajo ot
    WHERE ot.id = orden_id
    AND (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = ot.empresa_id
  )
)
WITH CHECK (
  EXISTS (
    SELECT 1 FROM public.ordenes_trabajo ot
    WHERE ot.id = orden_id
    AND (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = ot.empresa_id
  )
);

-- Política de DELETE para orden_trabajo_items
CREATE POLICY "orden_trabajo_items_delete_policy" ON public.orden_trabajo_items
FOR DELETE
USING (
  EXISTS (
    SELECT 1 FROM public.ordenes_trabajo ot
    WHERE ot.id = orden_id
    AND (SELECT empresa_id FROM public.usuarios WHERE auth_user_id = auth.uid()) = ot.empresa_id
  )
);
```

## 3. Funciones RPC (Recomendadas para Transacciones)

### 3.1. Función para crear orden con ítems (Transacción Atómica)
```sql
CREATE OR REPLACE FUNCTION public.crear_orden_con_items(
  p_cliente_id uuid,
  p_fecha_entrega date,
  p_hora_entrega time,
  p_items jsonb,
  p_adelanto numeric DEFAULT 0,
  p_total_personalizado numeric DEFAULT NULL,
  p_notas text DEFAULT NULL,
  p_estado text DEFAULT 'pendiente'
) RETURNS uuid
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_empresa_id uuid;
  v_orden_id uuid;
  v_item jsonb;
BEGIN
  -- Obtener empresa_id del usuario actual
  SELECT empresa_id INTO v_empresa_id
  FROM public.usuarios
  WHERE auth_user_id = auth.uid();
  
  IF v_empresa_id IS NULL THEN
    RAISE EXCEPTION 'Usuario no encontrado o no tiene empresa asignada';
  END IF;
  
  -- Verificar que el cliente pertenece a la misma empresa
  IF NOT EXISTS (
    SELECT 1 FROM public.clientes 
    WHERE id = p_cliente_id AND empresa_id = v_empresa_id
  ) THEN
    RAISE EXCEPTION 'Cliente no encontrado o no pertenece a la empresa';
  END IF;
  
  -- Crear la orden
  INSERT INTO public.ordenes_trabajo (
    cliente_id,
    empresa_id,
    auth_user_id,
    adelanto,
    total_personalizado,
    notas,
    estado,
    fecha_entrega,
    hora_entrega
  ) VALUES (
    p_cliente_id,
    v_empresa_id,
    auth.uid(),
    p_adelanto,
    p_total_personalizado,
    p_notas,
    p_estado,
    p_fecha_entrega,
    p_hora_entrega
  ) RETURNING id INTO v_orden_id;
  
  -- Insertar los ítems
  FOR v_item IN SELECT * FROM jsonb_array_elements(p_items)
  LOOP
    INSERT INTO public.orden_trabajo_items (
      orden_id,
      trabajo_nombre,
      trabajo_precio_m2,
      ancho,
      alto,
      cantidad,
      adicional
    ) VALUES (
      v_orden_id,
      (v_item->>'trabajo_nombre')::text,
      (v_item->>'trabajo_precio_m2')::numeric,
      (v_item->>'ancho')::numeric,
      (v_item->>'alto')::numeric,
      (v_item->>'cantidad')::integer,
      COALESCE((v_item->>'adicional')::numeric, 0)
    );
  END LOOP;
  
  RETURN v_orden_id;
END;
$$;
```

### 3.2. Función para obtener órdenes con detalles completos
```sql
CREATE OR REPLACE FUNCTION public.obtener_ordenes_completas()
RETURNS TABLE (
  orden_id uuid,
  cliente_nombre text,
  cliente_email text,
  cliente_celular text,
  adelanto numeric,
  total_personalizado numeric,
  notas text,
  estado text,
  fecha_entrega date,
  hora_entrega time,
  created_at timestamptz,
  items jsonb
)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_empresa_id uuid;
BEGIN
  -- Obtener empresa_id del usuario actual
  SELECT empresa_id INTO v_empresa_id
  FROM public.usuarios
  WHERE auth_user_id = auth.uid();
  
  IF v_empresa_id IS NULL THEN
    RAISE EXCEPTION 'Usuario no encontrado o no tiene empresa asignada';
  END IF;
  
  RETURN QUERY
  SELECT 
    ot.id as orden_id,
    c.nombre as cliente_nombre,
    c.email as cliente_email,
    c.celular as cliente_celular,
    ot.adelanto,
    ot.total_personalizado,
    ot.notas,
    ot.estado,
    ot.fecha_entrega,
    ot.hora_entrega,
    ot.created_at,
    COALESCE(
      jsonb_agg(
        jsonb_build_object(
          'id', oti.id,
          'trabajo_nombre', oti.trabajo_nombre,
          'trabajo_precio_m2', oti.trabajo_precio_m2,
          'ancho', oti.ancho,
          'alto', oti.alto,
          'cantidad', oti.cantidad,
          'adicional', oti.adicional
        ) ORDER BY oti.id
      ) FILTER (WHERE oti.id IS NOT NULL),
      '[]'::jsonb
    ) as items
  FROM public.ordenes_trabajo ot
  JOIN public.clientes c ON ot.cliente_id = c.id
  LEFT JOIN public.orden_trabajo_items oti ON ot.id = oti.orden_id
  WHERE ot.empresa_id = v_empresa_id
  GROUP BY ot.id, c.nombre, c.email, c.celular, ot.adelanto, ot.total_personalizado, 
           ot.notas, ot.estado, ot.fecha_entrega, ot.hora_entrega, ot.created_at
  ORDER BY ot.created_at DESC;
END;
$$;
```

## 4. Índices para Optimización

```sql
-- Índices para mejorar el rendimiento
CREATE INDEX idx_usuarios_auth_user_id ON public.usuarios(auth_user_id);
CREATE INDEX idx_usuarios_empresa_id ON public.usuarios(empresa_id);
CREATE INDEX idx_clientes_empresa_id ON public.clientes(empresa_id);
CREATE INDEX idx_trabajos_empresa_id ON public.trabajos(empresa_id);
CREATE INDEX idx_ordenes_trabajo_empresa_id ON public.ordenes_trabajo(empresa_id);
CREATE INDEX idx_ordenes_trabajo_cliente_id ON public.ordenes_trabajo(cliente_id);
CREATE INDEX idx_orden_trabajo_items_orden_id ON public.orden_trabajo_items(orden_id);
```

## 5. Comandos de Ejecución

Para ejecutar toda esta configuración en Supabase:

1. **Accede al Dashboard de Supabase**
2. **Ve a SQL Editor**
3. **Ejecuta los comandos en el siguiente orden:**
   - Primero los ENUMs
   - Luego las tablas (en orden de dependencias)
   - Después las políticas RLS
   - Finalmente las funciones RPC e índices

4. **Verifica la configuración:**
```sql
-- Verificar que las tablas fueron creadas
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('empresas', 'usuarios', 'clientes', 'trabajos', 'ordenes_trabajo', 'orden_trabajo_items');

-- Verificar que RLS está activado
SELECT schemaname, tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename IN ('clientes', 'trabajos', 'ordenes_trabajo', 'orden_trabajo_items');

-- Verificar políticas
SELECT schemaname, tablename, policyname 
FROM pg_policies 
WHERE schemaname = 'public';
```

## Notas Importantes

1. **Seguridad**: Todas las políticas RLS aseguran que los usuarios solo puedan acceder a datos de su propia empresa.

2. **Roles**: Los trabajos solo pueden ser gestionados por usuarios con rol 'admin'.

3. **Transacciones**: Usa la función `crear_orden_con_items` para asegurar atomicidad al crear órdenes.

4. **Migración**: Recuerda migrar los datos existentes de Hive a Supabase antes de activar el nuevo sistema.

5. **Backup**: Siempre realiza un backup de los datos antes de ejecutar la migración.
